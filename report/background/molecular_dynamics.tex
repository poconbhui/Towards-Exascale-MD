%
% Molecular Dynamics
%
\section{Molecular Dynamics}

%
%Q: What exactly is an MD simulation?
A classical MD simulation is performed by
solving the Newtonian equations of motion for
an atomic system.
%
As there are typically more than 3 bodies interacting in the simulation,
it is not possible to solve the general form of these equations analytically
\cite{vsuvakov2013three}.
%
The system must be solved numerically.

%
%Q: What bits do we need to make a simulation?
An example classical MD loop is outlined in \FIG{fig:md_loop_flow_chart}.
%
A simulation typically requires a force evaluation scheme
and a numerical integration scheme
\cite[p.~64]{frenkel2001understanding}.
%
This study will evaluate several parallel force evaluation schemes.
%
Of particular interest will be force evaluation schemes based on
the replicated data and systolic loop patterns.
%
The \velocityverlet{} scheme will be used to perform the integration steps.
%
As will be seen, the \velocityverlet{} scheme deviates slightly from
the loop outlined in \FIG{fig:md_loop_flow_chart} by sandwiching the
force finding step with two partial integration steps.

\begin{figure}[!h]
    \begin{center}
        \begin{tikzpicture}[node distance = 3.5cm, auto]
            % Place nodes
            \node [block] (init) {Initialise simulation};
            \node [block, right of=init] (forces) {Determine forces};
            \node [block, below of=forces] (step) {Integrate time step};
            \node [block, below of=step] (measure) {Measure system};
            \node [decision, right of=step] (isdone) {Simulation finished?};
            \node [block, right of=isdone] (exit) {End simulation};
            % Draw edges
            \path [line] (init) -- (forces);
            \path [line] (forces) -- (step);
            \path [line] (step) -- (measure);
            \path [line] (measure) -| (isdone);
            \path [line] (isdone) |- node [near start] {no} (forces);
            \path [line] (isdone) -- node {yes} (exit);
        \end{tikzpicture}
    \end{center}
    \caption{An example MD simulation loop.}
    \label{fig:md_loop_flow_chart}
\end{figure}


%
%Q: What do we need to do with those bits to get data?
An MD simulation typically consists of three phases as outlined in
\FIG{fig:phases_of_md_simulation}:
Initialise the system of particles;
simulate the system until it comes to thermodynamic equilibrium; and
simulate and measure the system
\cite[p.~394]{schlick2010molecular}.
%
%Q: Why do we need the system to reach thermodynamic equilibrium?
The system must be allowed to reach thermodynamic equilibrium because
the initial distribution of particles may be a statistically unlikely
configuration.
%
The system must be allowed some time to traverse the phase space to
a likely configuration.
%
If measurements of the system are taken before this stage,
statistically unlikely ensembles will be sampled more frequently than
they should be when performing measurements.
%
Measurements such as
temperature and energy
taken at this stage will not be
representative of the system being studied.

\begin{figure}[!h]
    \begin{center}
        \begin{tikzpicture}[node distance = 4cm, auto]
            % Place nodes
            \node [block] (init) {Initialise simulation};
            \node [block, right of=init] (equilibriate) {Equilibriate system};
            \node [block, right of=equilibriate] (perform) {
                Simulate and measure system
            };
            % Place paths
            \path [line] (init) -- (equilibriate);
            \path [line] (equilibriate) -- (perform);
        \end{tikzpicture}
    \end{center}
    \caption{The phases of a classical MD simulation}
    \label{fig:phases_of_md_simulation}
\end{figure}


%
%Q: What physical constraints does an MD simulation conform to?
An MD system,
assuming homogeneity of time,
homogeneity of space and
isotropy of space
should conserve energy, linear momentum and angular momentum
\cite{landau1976mechanics}.
%
%Q: Can we use these to tell anything about our simulation?
Measurements of these values can be used to
determine the ``health'' of a simulation
\cite[p.~72]{frenkel2001understanding}.
%
%Q: What does the conformance to these tell us about our simulation?
If any of these values change over the course of a simulation,
it is an indicator that either the system has become unphysical or
significant numerical error is creeping into the simulation.
%
%Q: If it necessarily conforms to these, is it still a valid simulation?
However, simply because these symmetries are conserved does not mean
the simulation is producing a correct result.
%
Indeed, a simulation may proceed perfectly, but not accurately reflect
the system it supposes to model due to
inappropriate approximations and truncations of
the potentials and the physics involved
\cite{patra2003molecular}.




\subsection{Equations Of Motion}

%
%Q: What is a potential?
In a molecular system, each particle generates a potential field
which is present throughout the system.
%
A particle has a potential energy determined by the sum
of the fields it experiences from the other particles in the system.
%
The gradient of that potential energy then determines
the force felt by that particle.

%
%Q: How do potentials differ for different systems?
The exact form of the potential depends on the system being studied.
%
Systems studied using Coulomb interactions, for example,
will have potentials that reach a constant value at relatively large distances
from a particle.
%
Systems studied using Van der Waals interactions will have
potentials that reach a constant value at relatively short distances from
a particle.
%
Several different inter-molecular and intra-molecular potentials may be used
in a simulation to more accurately model certain underlying behaviours
\cite{smith1996dl_poly_2}.


%
%Q: What are the equations of motion for a 2-body potential?
The Hamiltonian for a system of $N$ bodies
interacting under a \twobody{} potential can be written
\begin{equation}
    H = \sum_{i=1}^N \frac{\vec{p}_i^{,2}}{2 m}
        + \sum_{i=1}^N \sum_{j<i}^N V(\vec{x}_i, \vec{x}_j)
\end  {equation}
where $H$ is the Hamiltonian,
$N$ is the number of bodies,
$m_i$ is the mass of body $i$,
$p_i$ is the momentum of body $i$,
$x_i$ is the position of body $i$ and
$V(\vec{x}_i, \vec{x}_j)$ is the \twobody{} interaction potential
between two bodies.
%
This equation assumes a scalar potential which is
a function of the distance between the particles.
%
This may be easily extended include terms involving charges.
%
The equations of motion may then be written
\begin{equation}
    m_i \vec{a}_i = -\sum_{\substack{j=1\\j\ne{}i}}^N
                    \vec{\nabla}_i V(\vec{x}_i, \vec{x}_j)
\end  {equation}


%
%Q: What is the Velocity Verlet integration scheme?
The equations of motion may be discretise and solved numerically
by using an appropriate integration scheme.
%
Using the \velocityverlet{} integration scheme,
a system of classical particles using a \twobody{} potential
may be stepped forward a time step $h$ using the equations
%
\begin{subequations}
\label{eqn:velocity_verlet_scheme}
\begin{align}
    \vec{v}_i(t + \tfrac{1}{2} h) &=
        \vec{v}_i(t) + \tfrac{1}{2}\vec{a}_i h
    \label{eqn:velocity_verlet_v1_update}
    \\
    \vec{x}_i(t + h) &=
        \vec{x}_i(t) + \vec{v}_i(t + \tfrac{1}{2} h) h
    \label{eqn:velocity_verlet_position_update}
    \\
    m_i \vec{a}_i(t + h) &=
        - \sum_{\substack{j=1\\j\ne{}i}}^N
            \vec{\nabla}_i V(\vec{x}_i(t+h), \vec{x}_j(t+h))
    \label{eqn:velocity_verlet_force_eval}
    \\
    \vec{v}_i(t+h) &=
        \vec{v}_i(t + \tfrac{1}{2} h) + \tfrac{1}{2} \vec{a}_i(t + h) h
    \label{eqn:velocity_verlet_v2_update}
\end{align}
\end{subequations}
where $t$ is the time,
$h$ is the step size,
$\vec{v}_i(t)$ is the velocity of body $i$ at time $t$,
$m_i$ is the mass of body $i$,
$\vec{a}_i(t)$ is the acceleration of body $i$ at time $t$,
$\vec{x}_i(t)$ is the position of body $i$ at time $t$ and
$V$ and $N$ are as described above.
%
%Q:What is the error in the VV scheme?
The error for this scheme is $\bigO{h^4}$ in position and
$\bigO{h^2}$ in velocity
\cite[p.~70]{frenkel2001understanding}
%
%Q: What is the time to solution for the VV scheme?
As can be seen from
\EQN{eqn:velocity_verlet_force_eval},
this produces an $\bigO{N^2}$ algorithm per time step
when used with a \twobody{} potential as
determining each of the $N$ accelerations $\vec{a}_i$ involves
perforing a summation over $N-1$ positions $\vec{x}_j$.

%
%Q: What time step do we need for the VV scheme?
The timescale at which atomic forces manifest is very short compared to
the timescale at which properties of a molecular system may emerge
\cite[p.~409]{frenkel2001understanding}.
%
As a result, the numerical integrator must use very short steps to
pick up atomic level effects, but must run for a long
time to pick up system level effects.
%
This results in very many time steps to calculate in order
to observe interesting phenomenon in a system, which
in itself introduces a significant time complexity
when performing a simulation
\cite[p.~403]{schlick2010molecular}.
%
This may be addressed with schemes such as multiple time scale MD
\cite{tuckerman1992reversible}.
%
However, the performance of numerical integration schemes is outside
the scope of this paper.


\subsection{The \LennardJones{} potential}
%
%Q: What is the Lennard-Jones potential?
In this dissertation, the \twobody{} potential used is
the \LennardJones{} potential
\cite{jones1924determination}
%
\begin{equation}
    \label{eqn:the_lennard_jones_potential}
    V_{LJ}(r) = 4\epsilon \left[
        \left( \frac{\delta}{r} \right)^{12}
        - \left( \frac{\delta}{r} \right)^{6}
    \right]
\end  {equation}
where $V_{LJ}(r)$ is the \LennardJones{} potential as
a function of the distance $r$,
$r$ is the distance between two bodies,
$\epsilon$ is the depth of the potential well and
$\delta$ is the distance at which
the potential switches from being attractive to repulsive.

\begin{figure}
    \input{background/lennard_jones_potential.plt}
    \caption{
        The \LennardJones{} Potential with
        $\epsilon = 1$ and $\delta = 1$
    }
    \label{fig:lennard_jones_potential}
\end  {figure}

%
%Q: What is the LJ potential useful for?
The \LennardJones{} potential, sketched in
\FIG{fig:lennard_jones_potential},
is useful for modelling simple particle interactions such as
Van der Waals interactions.
%
Typically, $\epsilon$ and $\delta$ are determined for a system by
fitting them to experimental data
\cite[p.~250]{schlick2010molecular}.


%
%Q: What are the equations of motion for the LJ potential under VV?
Using the \LennardJones{} potential, the \twobody{} term in the Hamiltonian
becomes
\begin{equation}
    V(\vec{x}_i(t), \vec{x}_j(t)) = V_{LJ}(|\vec{x}_i(t) - \vec{x}_j(t)|)
\end  {equation}
%
Writing
$\vec{r}_{ij} = \vec{x}_j - \vec{x}_i$,
$r_{ij} = |\vec{r}_{ij}|$ and
$\hat{r}_{ij} = \frac{\vec{r}_{ij}}{r_{ij}}$
the gradient of this is
\begin{equation}
    \vec{\nabla}_i V_{LJ}(r_{ij}) = 4\epsilon \left[
        - \frac{12}{r_{ij}} \left( \frac{\delta}{r_{ij}} \right)^{12}
        + \frac{6}{r_{ij}} \left( \frac{\delta}{r_{ij}} \right)^{6}
    \right] \hat{r}
\end  {equation}
which may be substituted into \EQN{eqn:velocity_verlet_force_eval} to describe
the discretised equations of motion of $N$ bodies interacting under the
\LennardJones{} potential.


\subsection{Truncation of Forces}

%
%Q: What is truncation?
When interacting under the \LennardJones{} potential,
when the distance between two bodies is large enough,
the addition of the potential difference between to their overall
potential energies them becomes negligible compared
to the contributions from closer bodies
\cite[p.~35]{frenkel2001understanding}.
%
In this case, it may be possible to approximate this potential difference
to zero, and leave this term out of the calculation entirely.
%
By implementing this approximation,
the time complexity of the simulation may be reduced.
%
When this is done, the forces are said to be truncated.

%
%Q: What is the importance of the effective length of our potentials?
Truncation can be implemented by
setting a cutoff distance and only evaluating potentials
between particles within this distance from each other.
%
This is the approach taken in the \verletlist{} and \celllist{} schemes
\cite[p.~545]{frenkel2001understanding}.
%
In this manner, each particle can be described as generating its own
isolated system of particles within its cutoff distance
at each time step
to be solved, without truncations, to step that particle forward in time.
%
In this case, it may be interesting to combine a truncation oriented
parallel scheme such as domain distribution with a scheme designed to integrate
the equations of motion without truncations.

%
%Q: What happens if we have periodic systems?
Truncation may be used to effectively simulate very large systems by using
a relatively small system with periodic boundary conditions,
and a potential with a cutoff distance that ensures that
no particle interacts with the same particle twice
\cite[p.~35]{frenkel2001understanding}.
%
This can be done by ensuring the cutoff distance is less than half the width
of the system.
%
With this approach, one hopes to simulate what looks like an infinite system
without introducing periodic effects.
%
As this is implemented by using a periodic system, however,
periodic effects cannot be completely removed or ruled out.
%
%Q: When we shrink our system sizes, what are the effects?
Steps can be taken to minimise them, such as ensuring the boundaries
of the simulation are large enough to avoid finite size effects
\cite[p.~220]{frenkel2001understanding}.
%
However, a detailed discussion about effects introduced by
truncation and boundary conditions are outide the scope of
this dissertation.

%
%Q: What happens if we have long range potentials?
Potentials can't be reasonably truncated if they are long ranged
\cite[p.~291]{frenkel2001understanding}.
%
For non-periodic systems, the equations of motion must be solved directly.
%
For periodic systems with long ranged potentials,
a very different approach must be used,
as each particle will interact with
an infinite number of copies of
every particle in the system in every possible direction.
%
The problem of computing these infinite sums can be addressed using
schemes such as Ewald summation
\cite{ewald1921berechnung}.
%
However, the discussion of evaluating long ranged potentials in periodic systems
is out of the scope of this dissertation.


\subsection{Approximations and Sensitivity}

Classical MD simulations do not account for quantum effects,
and as such make some false predictions
\cite[p.~390]{schlick2010molecular}.
%
For example, A quantum approach would yield
a different distribution of
molecular vibrational frequencies to a classical approach.
%
Typically, a classical simulation will yield incorrect results
where dealing with high speeds or low temperatures.
%
This limits the areas where it may be used for study.

There are several potential issues regarding accuracy in MD simulations.
%
An $N$ body system is a chaotic one.
%
As a result, a small change in accuracy may lead to
largely different results
\cite[p.~81]{frenkel2001understanding}.
%
Errors may be introduced by
the numerical integration scheme used,
the time step used,
approximations of potentials
and truncations.
%
While a final answer may not be accurate,
the simulation may still be useful.
%
The system may be used to derive information on
thermodynamic variables or to simulate general trends
\cite[p.~399]{schlick2010molecular}.

Overzealous truncation may lead to a simulation that supposes to
model a particular system of particles, but instead overapproximates
the physics involved and produces incorrect results.
%
However, overzealous truncation may be necessary to run a simulation
within a reasonable timeframe.
%
By increasing this cutoff distance, the accuracy of a simulation may
by slightly improved.
